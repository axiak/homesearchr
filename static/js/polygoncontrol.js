function PolygonControl(opt_opts){var me=this;me.type="polygon";me.name=me.type+"Control";me.zuper=null;me.digitizerShape=null;me.editLineHandler=null;me.endLineHandler=null;me.infoWindowHtml="";me.infoWindowTabs=[];me.styles={standard:{}};me.storage=[];me.Options={button_opts:{img_up_url:'http://www.google.com/intl/en_us/mapfiles/ms/t/Bpu.png',img_down_url:'http://www.google.com/intl/en_us/mapfiles/ms/t/Bpd.png',name:'polygon',tooltip:'Draw a shape'},position:{controlPosition:[75,3]},tooltip:{anchor:[-30,-8],cursor_on:"",cursor_off:"",titles:{start:"Click to start drawing a shape",middle:"Click to continue drawing a shape",end:"Click a vertex once, or double click on the map to end this shape"},callback:null},newGeometryOptions:{strokeColor:"#000000",strokeWeight:3,strokeOpacity:0.25,fillColor:"#0000FF",fillOpacity:0.45,opts:{clickable:true}},geometryListenerOpts:{mouseoverEditingEnabled:true,infoWindowHtmlEnabled:true,mouseoverHighlightingEnabled:true,infoWindowTabsEnabled:false,assembleInfoWindowTabs:function(){me.infoWindowTabs.push(new GInfoWindowTab("Geometry Controls",me.infoWindowHtml));me.infoWindowTabs.push(new GInfoWindowTab("Example Tab",me.zuper.infoWindowHtmlTemplates["infoWindowTabContent1"]));}},multiEdit:false,htmlTemplateParams:{},cssId:"emmc-polygon",optionalGeometryListeners:null,autoSave:false};if(typeof(opt_opts)!="undefined"){for(var o in opt_opts){if(typeof(opt_opts[o])==="object"){for(var p in opt_opts[o]){me.Options[o][p]=opt_opts[o][p];}}else{me.Options[o]=opt_opts[o];}}}else{}};PolygonControl.prototype=new GControl();PolygonControl.prototype.getDefaultPosition=function(){var me=this;return me.zuper.getDefaultPosition(me.Options.position);};PolygonControl.prototype.initialize=function(map){var me=this;me.container=document.createElement("div");me.container.id="mymaps-control-"+me.Options.button_opts.name;var button=me.zuper.createButton({controlName:me.name,button_opts:me.Options.button_opts,startDigitizing:function(){me.startDigitizing();},stopDigitizing:function(t){me.stopDigitizing(t);}});me.container.appendChild(button.img);map.getContainer().appendChild(me.container);me.runInitFunctions();return me.container;};PolygonControl.prototype.runInitFunctions=function(){var me=this;me.tooltip();me.assembleInfoWindowHtml(me.Options.htmlTemplateParams);me.extendGPolygon();};PolygonControl.prototype.startDigitizing=function(){var me=this,zuper=me.zuper,map=zuper.map,Options=me.Options;me.tooltip.on(Options.tooltip.titles["start"]);me.digitizerShape=me.newGPolygon([],Options.newGeometryOptions);map.addOverlay(me.digitizerShape);me.digitizerShape.enableDrawing({});me.editLineHandler=GEvent.addListener(me.digitizerShape,"lineupdated",function(){switch(me.digitizerShape.getVertexCount()){case 2:me.tooltip.tooltipContainer.innerHTML=Options.tooltip.titles["middle"];break;case 3:me.tooltip.tooltipContainer.innerHTML=Options.tooltip.titles["end"];break;}});GEvent.addListener(me.digitizerShape,"cancelline",function(){me.stopDigitizing();});me.endLineHandler=GEvent.addListener(me.digitizerShape,"endline",function(latlng){var coords=[];for(var i=0;i<me.digitizerShape.getVertexCount();i++){coords[i]=me.digitizerShape.getVertex(i);}
var polygon=me.createPolygon(coords,me.infoWindowHtml);map.addOverlay(polygon);if(!Options.multiEdit){me.stopDigitizing();GEvent.trigger(polygon,"click");}else{}});};PolygonControl.prototype.stopDigitizing=function(toggleButtons){var me=this,zuper=me.zuper;try{GEvent.removeListener(me.endLineHandler);}catch(e){};me.tooltip.off();if(toggleButtons!==false){zuper.toggleButtons();}
zuper.setLocalTimeout(function(){if(me.digitizerShape){me.digitizerShape.disableEditing();zuper.map.removeOverlay(me.digitizerShape);me.digitizerShape=null;}},500);};PolygonControl.prototype.tooltip=function(){var me=this;var tooltip=me.zuper.tooltipFactory(me.Options.tooltip);me.tooltip=tooltip;return tooltip;};PolygonControl.prototype.assembleInfoWindowHtml=function(dataObject){var me=this,zuper=me.zuper,zuperHtml=zuper.infoWindowHtmlTemplates;dataObject=dataObject||{};dataObject["geometry_style_link"]=zuperHtml["geometry_style_link_params"][0][me.type];me.infoWindowHtml=zuper.parseMicroTemplate("template_1",dataObject,zuperHtml["template_1"])+zuperHtml["polygon_2"];if(me.Options.geometryListenerOpts.infoWindowTabsEnabled){me.Options.geometryListenerOpts.assembleInfoWindowTabs();}};PolygonControl.prototype.createPolygon=function(coords,html,opt_currentIndex,opt_currentStyle){var me=this,Options=me.Options;var isNewPolygon=(typeof(opt_currentIndex)==="number")?false:true;var index=(isNewPolygon)?me.storage.length:opt_currentIndex;var savedStyle=opt_currentStyle||Options.newGeometryOptions;var polygon=me.newGPolygon(coords,savedStyle);polygon.index=index;polygon.savedStyle=savedStyle;polygon.unsavedStyle={};me.addGeometryListeners(polygon,html);if(isNewPolygon){me.storage[index]=new me.zuper.beans.Geometry({type:me.type,geometry:polygon});}else{me.storage[index].geometry=polygon;}
me.updateLocationData();return polygon;};PolygonControl.prototype.updateLocationData=function(){var me=this;result="";var has_point=false;var old_result=$("#location-data")[0].value;for(var i=0;i<me.storage.length;i++){if(me.storage[i]){result+=",p";for(var j=0;j<me.storage[i].geometry.getVertexCount();j++){has_point=true;var ll=me.storage[i].geometry.getVertex(j);var lat=ll.lat();var lng=ll.lng();result+=","+lat+","+lng;}}}
if(!has_point){$("#location-data").val("");}
else{$("#location-data").val(result);}
if(old_result!=result){update_form();}}
PolygonControl.prototype.addGeometryListeners=function(polygon,html){var me=this,opts=me.Options.geometryListenerOpts,map=me.zuper.map;if(opts.mouseoverEditingEnabled){GEvent.addListener(polygon,"mouseover",function(){polygon.enableEditing();me.updateLocationData();});GEvent.addListener(polygon,"mouseout",function(){polygon.disableEditing();me.updateLocationData();});}
if(opts.infoWindowHtmlEnabled&&!opts.infoWindowTabsEnabled){GEvent.addListener(polygon,"click",function(para){var latlng=para||polygon.getBounds().getCenter();map.openInfoWindowHtml(latlng,html);me.bindInfoWindow(polygon);me.updateLocationData();});}
if(opts.infoWindowTabsEnabled&&!opts.infoWindowHtmlEnabled){GEvent.addListener(polygon,"click",function(para){var latlng=para||polygon.getBounds().getCenter();map.openInfoWindowTabs(latlng,me.infoWindowTabs);me.bindInfoWindow(polygon);me.updateLocationData();});}
if(opts.mouseoverHighlightingEnabled){GEvent.addListener(polygon,"mouseover",function(){polygon.setFillStyle({opacity:(polygon.unsavedStyle.fillOpacity||polygon.savedStyle.fillOpacity)+0.3});});GEvent.addListener(polygon,"mouseout",function(){polygon.setFillStyle({opacity:(polygon.unsavedStyle.fillOpacity||polygon.savedStyle.fillOpacity)});});}
if(me.Options.optionalGeometryListeners){me.Options.optionalGeometryListeners(polygon);me.updateLocationData();}
return polygon;};PolygonControl.prototype.bindInfoWindow=function(polygon){var me=this,Options=me.Options,index=polygon.index;var styleLink=(me.zuper.isIE)?get$("msiwsi").childNodes[0]:get$("msiwsi").childNodes[1];styleLink.style.backgroundColor=polygon.savedStyle.fillColor;me.zuper.bindInfoWindow({index:index,storage:me.storage,geometryStyleFunc:function(){me.bindStyleInfoWindow(index);},undoStyling:function(){me.changeStyling(index,polygon.savedStyle);polygon.unsavedStyle={};},commitStyling:function(){for(var p in polygon.unsavedStyle){polygon.savedStyle[p]=polygon.unsavedStyle[p];}
polygon.unsavedStyle={};for(var o in polygon.savedStyle){Options.newGeometryOptions[o]=polygon.savedStyle[o];}}});};PolygonControl.prototype.bindStyleInfoWindow=function(index){var me=this,cssId=me.zuper.Options.cssId;var geometry=me.storage[index].geometry;var savedStyle=geometry.savedStyle;var unsavedStyle=geometry.unsavedStyle;var lineColor=get$(cssId+"-line-color");var lineWidth=get$(cssId+"-line-width");var lineOpacity=get$(cssId+"-line-opacity");var fillColor=get$(cssId+"-fill-color");var fillOpacity=get$(cssId+"-fill-opacity");var geomStyleDiv=get$(cssId+"-style");lineColor.style.backgroundColor=unsavedStyle.strokeColor||savedStyle.strokeColor;lineWidth.value=geometry.getStrokeWeight();lineOpacity.value=geometry.getStrokeOpacity();fillColor.style.backgroundColor=unsavedStyle.fillColor||savedStyle.fillColor;fillOpacity.value=geometry.getFillOpacity();GEvent.addDomListener(lineColor,"click",function(){me.zuper.showColorPicker({target:lineColor,callback:function(color){me.changeStyling(index,{strokeColor:color});}});});GEvent.addDomListener(fillColor,"click",function(){me.zuper.showColorPicker({target:fillColor,callback:function(color){me.changeStyling(index,{fillColor:color});}});});GEvent.addDomListener(get$("emmc-geom-style-back"),"click",function(){me.changeStyling(index,{stroke:{color:savedStyle.strokeColor},fill:{color:savedStyle.fillColor}});geomStyleDiv.style.display="none";});GEvent.addDomListener(get$("emmc-msls-ok"),"click",function(){var hackMemoryLeakFix=parseInt(geometry.setStrokeWeight(lineWidth.value));me.changeStyling(index,{strokeWeight:hackMemoryLeakFix,strokeOpacity:geometry.setStrokeOpacity(lineOpacity.value),fillOpacity:geometry.setFillOpacity(fillOpacity.value),strokeColor:lineColor.style.backgroundColor,fillColor:fillColor.style.backgroundColor});var styleLink=(me.zuper.isIE)?get$("msiwsi").childNodes[0]:get$("msiwsi").childNodes[1];styleLink.style.backgroundColor=fillColor.style.backgroundColor;geomStyleDiv.style.display="none";});};PolygonControl.prototype.changeStyling=function(index,styles){var me=this;var geometry=me.storage[index].geometry;if(styles){var stroke={},strokeFlag=false,fill={},fillFlag=false;for(var style in styles){if(style.indexOf("stroke")>-1){var shortName=style.replace("stroke","").toLowerCase();stroke[shortName]=strokeFlag=styles[style];}
if(style.indexOf("fill")>-1){var shortName=style.replace("fill","").toLowerCase();fill[shortName]=fillFlag=styles[style];}}
if(strokeFlag){geometry.setStrokeStyle(stroke);}
if(fillFlag){geometry.setFillStyle(fill);}
for(var o in styles){geometry.unsavedStyle[o]=styles[o];}}};PolygonControl.prototype.hoverTooltip=function(){};PolygonControl.prototype.loadPolygons=function(record){var me=this;var polygon=me.createPolygon(record.coordinates,me.infoWindowHtml,false,record.style);me.storage[polygon.index].title=[record.title,record.title];me.storage[polygon.index].description=[record.description,record.description];me.zuper.map.addOverlay(polygon);return polygon;};PolygonControl.prototype.newGPolygon=function(coords,opts){return new GPolygon(coords,opts.strokeColor,opts.strokeWeight,opts.strokeOpacity,opts.fillColor,opts.fillOpacity,opts.opts);};PolygonControl.prototype.extendGPolygon=function(){GPolygon.unsavedStyle={};GPolygon.savedStyle={};GPolygon.prototype.getStrokeWeight=function(){return(this.unsavedStyle.strokeWeight||this.savedStyle.strokeWeight);};GPolygon.prototype.setStrokeWeight=function(weight){if(!isNaN(weight)){this.unsavedStyle.strokeWeight=(weight>20)?20:(weight<1)?1:weight;}else{this.unsavedStyle.strokeWeight=this.savedStyle.strokeWeight;}
return this.unsavedStyle.strokeWeight||this.savedStyle.strokeWeight;};GPolygon.prototype.getStrokeOpacity=function(){return(this.unsavedStyle.strokeOpacity||this.savedStyle.strokeOpacity)*100;};GPolygon.prototype.setStrokeOpacity=function(opacity){if(!isNaN(opacity)){var storedOpacity=(opacity>100)?100:(opacity<0)?0:opacity;this.unsavedStyle.strokeOpacity=storedOpacity/100;}else{this.unsavedStyle.strokeOpacity=this.savedStyle.strokeOpacity;}
return this.unsavedStyle.strokeOpacity||this.savedStyle.strokeOpacity;};GPolygon.prototype.getFillOpacity=function(){return(this.unsavedStyle.fillOpacity||this.savedStyle.fillOpacity)*100;};GPolygon.prototype.setFillOpacity=function(opacity){if(!isNaN(opacity)){var storedOpacity=(opacity>100)?100:(opacity<0)?0:opacity;this.unsavedStyle.fillOpacity=storedOpacity/100;}else{this.unsavedStyle.fillOpacity=this.savedStyle.fillOpacity;}
return this.unsavedStyle.fillOpacity||this.savedStyle.fillOpacity;};};
